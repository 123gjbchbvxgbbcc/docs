# 深入工作区

::: tip
阅读本节前请先阅读 [工作区开发](../../guide/develop/workspace.md)。
:::

::: tip
本文将回答以下问题：

- 什么是工作区仓库？相比其他开发模式有什么优势？
- 如何在一个仓库中开发多个插件？
- 整合包是什么？如何开发与发布整合包？
:::

本文要介绍的主题是 Yakumo。Yakumo 是一个由 Koishi 官方团队开发的项目管理工具，它内置于模板项目中，可以在一个本地目录中管理来自多个仓库的工作区。

Yakumo 这个词对应于日语中的“八云”。在东方 Project 中，八云紫是境界的妖怪，幻想乡的贤者之一。她的式神八云蓝甚至也有着自己的式神橙。我们使用 Yakumo 这个名字，意在表示这个工具具备管理嵌套工作区的能力。

## 现状

在我们介绍工作区仓库机制之前，先来看看目前的主流开发模式。

### 独立仓库

在此模式下，每一个包都由一个独立的 Git 仓库进行管理。这种开发模式存在许多缺点：

1. 每个包的依赖都需要单独安装，这会占据大量重复的磁盘空间。
2. 每个包需要独立管理，无法使用统一的工具对所有包进行调试、更新和发布。
3. 当修改了某一个库的源码后，必须经过构建和发布才能在其他项目中使用。既无法直接在真实项目中运行源代码，也无法对多个仓库的源码进行联合调试。

### 复合仓库 (Monorepo)

认识到上述问题后，Node.js 社区很快发展出了复合仓库 (monorepo) 的开发模式。在此模式下，将多个相关联的包交给同一个 Git 仓库进行管理。每一个包都被视为一个**工作区 (Workspace)**，而整个仓库同样视为一个根工作区。可以看到，上述几个缺点得到了很大程度的解决：

1. 根工作区会安装所有子工作区的依赖，不会出现重复安装，因此问题 1 得到了解决。
2. 一些工具 (例如 Lerna) 可以对所有工作区进行统一的管理，因此问题 2 得到了解决。
3. 可以将根工作区视为一个真实项目，其中的包可以联合调试，因此问题 3 得到了解决。

目前主流的 Node.js 包管理器 npm 和 yarn 都已经提供了标准化的复合仓库支持 (pnpm 同样支持工作区，但与标准实现不一致)。一些其他语言也提供了类似的能力 (例如 Rust 的 Cargo)。

### 子模块 (Submodule)

子模块 (Submodule) 在 Node.js 生态中很少出现，不过对于其他语言还是比较常见的。在此模式下，每一个包仍然由一个独立的 Git 仓库进行管理，但是在根仓库中使用子模块的方式引入。

这种开发模式的优缺点与独立仓库类似。尽管问题 2 得到了解决，子模块也引入了额外的麻烦。由于子模块的设计缺陷，在切换仓库分支、重命名父级目录等操作前，都需要妥善维护子模块的状态。一旦初学者处理不当，就可能导致父仓库完全不可用。

## 工作区仓库

Koishi 的模板项目同样采用了基于工作区的开放模式。但与传统的复合仓库不同

## 关于 `.gitignore` 的讨论

关于 Koishi 的工作区开发，一些有趣的问题围绕 `.gitignore` 展开。打开模板项目根目录下的 `.gitignore`，你会发现其中忽略了很多文件，包括存放本地插件的 `external` 目录和各种包管理器的 lockfile (例如 `package-lock.json` 和 `yarn.lock`)。

乍一看你或许会觉得 Koishi 的做法与主流的管理模式不同，但实际上这套解决方案既经过了深思熟虑，也有着长期的实践检验。现在就让我们来解释一下。

首先，目前默认创建出的模板项目并不会包含 Git 功能，这里的 `.gitignore` 实际上是为整合包开发而准备的。换言之，Koishi 推荐的模板项目开发方式并不推荐将创建出的模板项目作为单独的仓库进行管理，而是将其中的每一个插件发布为独立的仓库。

你可以将这种开发模式称为“工作区分发”。与之相对地，我们熟知的传统开发模式可以成为“项目分发”。单仓库 (monorepo) 的开发方式也属于后一类，稍后会进行对比。

### 为什么要使用工作区分发？

工作区分发的开发模式具备以下几点好处。

首先，模板项目的根目录中有各种配置文件，其中存在着大量的隐私数据。初学者很容易因为失误而提交这些文件，不发布根目录可以有效避免这些数据的泄露。

其次，Koishi 希望营造健康的开源生态，因此非常看重二次开发体验 (即对其他开发者编写的插件进行调试、修改和贡献)。本地环境下可能存在非常多的插件，所依赖的环境也可能十分复杂。如果开发者直接发布完整的本地开发目录，那么进行二次开发时就可能为了自己不需要的插件安装额外的依赖，甚至可能因为环境不同而无法顺利开发。而工作区分发则允许开发者只克隆自己需要的插件仓库，从而避免了这些问题。

不过，工作区开发也有一些缺点。当多个插件之间存在耦合关系时，为每个插件分别创建一个 Git 仓库就显得不太合理了。对于这种场景，Koishi 也提供了两种解决方案：

1. 使用单仓库 (monorepo) 工作区，实现一个仓库管理多个插件
2. 使用整合包的 `packages` 目录，直接在整合包中管理多个插件

### 为什么不提交 lockfile？

## 整合包开发

::: warning
未完待续。
:::
